# CoreDNS Corefile for unwiredin.com and default forwarding

# Internal zone: unwiredin.com
# Handles DNS queries specifically for the unwiredin.com domain internally.
unwiredin.com {
    bind 10.10.1.2 # Listen only on this IP for this zone
    
    # Static entries via a hosts-file-like format for unwiredin.com
    # Good for quick overrides or a few specific records.
    hosts /etc/coredns/hosts.unwiredin.com {
        reload 10s    # Reload this hosts file every 10 seconds if it changes
        fallthrough   # If a name isn't found here, pass the query to the next plugin (file)
    }
    
    # Zone file for unwiredin.com
    # Main source of DNS records for this zone.
    file /etc/coredns/zones/db.unwiredin.com
    
    reload 1m  # Check for zone file changes every minute
    log    # Enable query logging for this zone
    errors # Enable error logging for this zone
}

# Default catch-all server block
# Handles all other DNS queries (for any domain not unwiredin.com).
. {
    bind 10.10.1.2 # Listen only on this IP
    
    # Forward queries to upstream DNS servers
    forward . 1.1.1.1 1.0.0.1 {
        health_check 5s         # Check upstream health every 5 seconds
        prefer_udp              # Prefer UDP for upstream queries
    }
    
    # Cache responses to speed up subsequent queries
    cache {
        success 512             # Max number of successful responses to cache
        denial 256              # Max number of denial (NXDOMAIN, etc.) responses to cache
        prefetch 2 30m          # Prefetch popular items (requested 2+ times) in last 30m of TTL
    }
    
    # Monitoring endpoints
    # Metrics endpoint will be at http://10.10.1.2:9153/metrics
    # Health endpoint will be at http://10.10.1.2:9153/health
    # Readiness endpoint will be at http://10.10.1.2:9153/ready
    prometheus :9153 # Expose Prometheus metrics on port 9153
    health           # Expose a health check endpoint
    ready            # Expose a readiness check endpoint
    reload 1m        # Check for Corefile changes every minute
    
    log    # Enable general query logging for forwarded/other queries
    errors # Enable general error logging
}